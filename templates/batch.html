{% extends "layout.html" %} {% block content %}
<div class="main-container">
  <div class="text-center mb-4">
    <h2>Batch Cancellation Prediction</h2>
    <p class="lead">
      Upload a CSV file with booking data to get predictions and insights for
      multiple bookings at once.
    </p>
  </div>

  <!-- File Upload Form -->
  <div class="card card-body shadow-sm mb-4">
    <form method="post" enctype="multipart/form-data">
      <div class="form-group">
        <label for="file">Select CSV File</label>
        <div class="custom-file">
          <input
            type="file"
            class="custom-file-input"
            name="file"
            id="file"
            accept=".csv"
            required
          />
          <label class="custom-file-label" for="file">Choose file...</label>
        </div>
        <small class="form-text text-muted"
          >The CSV must contain columns like 'hotel', 'lead_time',
          'arrival_date_month', etc., matching the training data.</small
        >
      </div>
      <button type="submit" class="btn btn-primary btn-block">
        Process and Predict
      </button>
    </form>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %} {% if
  messages %} {% for category, message in messages %}
  <div class="alert alert-{{ category }}">{{ message }}</div>
  {% endfor %} {% endif %} {% endwith %}

  <!-- Results and Insights Section (This will only show if results_html exists) -->
  {% if results_html %}
  <div id="results-section">
    <hr class="my-4" />
    <h3 class="text-center mb-4">Analysis Report</h3>

    <!-- Insight Cards -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card text-white bg-info h-100">
          <div class="card-body">
            <h5 class="card-title">Total Bookings Analyzed</h5>
            <p class="card-text display-4">{{ total_bookings }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-white bg-danger h-100">
          <div class="card-body">
            <h5 class="card-title">Predicted Cancellations</h5>
            <p class="card-text display-4">{{ total_cancellations }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-light h-100">
          <div class="card-body">
            <h5 class="card-title">Cancellations by Month</h5>
            {% if monthly_cancellations %}
            <ul class="list-group list-group-flush">
              {% for month, count in monthly_cancellations.items() %}
              <li
                class="list-group-item d-flex justify-content-between align-items-center bg-transparent"
              >
                {{ month }}
                <span class="badge badge-danger badge-pill">{{ count }}</span>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p>No cancellations predicted.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Recommendation Card -->
    <div class="card bg-light mb-4">
      <div class="card-header font-weight-bold">Actionable Recommendation</div>
      <div class="card-body">
        <p class="card-text">{{ recommendation }}</p>
      </div>
    </div>

    <!-- Detailed Results Table -->
    <h4 class="mb-3">Detailed Predictions</h4>
    <div class="table-responsive">{{ results_html | safe }}</div>
  </div>
  {% endif %}
</div>

<!-- JavaScript to show the selected filename in the upload form -->
<script>
  if (document.querySelector(".custom-file-input")) {
    document
      .querySelector(".custom-file-input")
      .addEventListener("change", function (e) {
        var fileName = document.getElementById("file").files[0].name;
        var nextSibling = e.target.nextElementSibling;
        nextSibling.innerText = fileName;
      });
  }
</script>

{% endblock %}
